<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">LodeLMmvn</a> &gt; <a href="index.source.html" class="el_package">utils</a> &gt; <span class="el_source">FileHandler.java</span></div><h1>FileHandler.java</h1><pre class="source lang-java linenums">package utils;

import java.io.*;
import java.util.List;

import java.security.*;
import javax.crypto.NoSuchPaddingException;
import javax.crypto.IllegalBlockSizeException;
import javax.crypto.BadPaddingException;
import javax.crypto.spec.SecretKeySpec;
import javax.crypto.SecretKey;

import java.io.FileWriter;
import java.util.Base64;
import java.nio.charset.StandardCharsets;

import com.opencsv.CSVWriter;
import com.opencsv.CSVReader;
import com.opencsv.exceptions.CsvException;
import com.opencsv.exceptions.CsvValidationException;

import java.util.ArrayList;

public class FileHandler {
    String path;
<span class="nc" id="L26">    int MAX_BUFFER_SIZE = 4096;</span>
<span class="nc" id="L27">    String csv = &quot;../user_permissions.csv&quot;;</span>

    /***
     * Constructor for FileHandler
     * 
     * String path: the path name of the file to be either sent, saved, or deleted 
     */
<span class="nc" id="L34">    public FileHandler (String path) {</span>
<span class="nc" id="L35">        this.path = path;</span>
<span class="nc" id="L36">    }</span>

    /***
     * Reads the file's contents via an input stream then sends file via the given output stream
     * 
     * DataOutputStream dataOutputStream: the output stream to write the file into
     * 
     * return: (String) output for user
     */
    public String sendFile(DataOutputStream dataOutputStream, SecretKey commKey, boolean isServer, String username) throws CsvValidationException, NoSuchProviderException, BadPaddingException, IllegalBlockSizeException, NoSuchPaddingException, InvalidKeyException, FileNotFoundException, InvalidAlgorithmParameterException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L46">        String userOutput = &quot;File Downloaded&quot;;</span>
<span class="nc" id="L47">        int bytes = 0;</span>
<span class="nc" id="L48">        File file = new File(this.path);</span>
        byte[] cipherText;
<span class="nc" id="L50">        FileEncryption fe = new FileEncryption();</span>

<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (isServer) {</span>
            // Decrypt the file before sending to client
<span class="nc" id="L54">            String[] filePermissionInfo = this.retrieveUserPermissionsCSV(username);</span>

<span class="nc bnc" id="L56" title="All 6 branches missed.">            if (filePermissionInfo != null &amp;&amp; filePermissionInfo.length == 3 &amp;&amp; filePermissionInfo[2].contains(&quot;r&quot;)) {</span>
<span class="nc" id="L57">                byte[] text = fe.decryptFile(file);</span>
                
<span class="nc" id="L59">                EncryptedCom.sendMessage(text, commKey, fe, dataOutputStream);</span>
<span class="nc" id="L60">            } else {</span>
<span class="nc" id="L61">                userOutput = &quot;You do not have the required permissions to download this file.&quot;;</span>
<span class="nc" id="L62">                EncryptedCom.sendMessage(&quot;cannot download&quot;.getBytes(), commKey, fe, dataOutputStream);</span>
            }
<span class="nc" id="L64">            return userOutput;</span>
        }
        else {
<span class="nc" id="L67">            FileInputStream fileInputStream = new FileInputStream(file);</span>

            // Read in file and write to destination
<span class="nc" id="L70">            int max_bytes = (int) Math.min(MAX_BUFFER_SIZE, file.length());</span>
<span class="nc" id="L71">            byte[] buffer = new byte[max_bytes];</span>
<span class="nc" id="L72">            fileInputStream.read(buffer, 0, max_bytes);</span>
<span class="nc" id="L73">            EncryptedCom.sendMessage(buffer, commKey, fe, dataOutputStream);</span>
<span class="nc" id="L74">            fileInputStream.close();</span>
        }
        // System.out.println(userOutput);
<span class="nc" id="L77">        return userOutput;</span>
    }

    /***
     * Receives file via the given input stream and writes it to the output stream
     * 
     * DataInputStream dataInputStream: the input stream to read in the file through
     * 
     * return: none
     */
    public String receiveFile(DataInputStream dataInputStream, SecretKey commKey, boolean isServer, String username) throws CsvException, CsvValidationException, NoSuchProviderException, BadPaddingException, IllegalBlockSizeException, NoSuchPaddingException, InvalidKeyException, FileNotFoundException, InvalidAlgorithmParameterException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L88">        String outputString = null;</span>

        // Read file in
<span class="nc" id="L91">        FileEncryption fe = new FileEncryption();</span>
<span class="nc" id="L92">        byte[] fileContent = EncryptedCom.receiveMessage(commKey, fe, dataInputStream);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (new String(fileContent, StandardCharsets.UTF_8).equals(&quot;cannot download&quot;)) {</span>
<span class="nc" id="L94">            return &quot;&quot;;</span>
        }

<span class="nc" id="L97">        int bytes = 0;</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (isServer) {</span>
<span class="nc" id="L100">            boolean appended = this.appendUserPermissionsCSV(username, null, &quot;rw&quot;);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (!appended) {</span>
<span class="nc" id="L102">                outputString = &quot;You do not have permission to override the current file with that name on the server. Please change the name of your file.&quot;;</span>
<span class="nc" id="L103">                return outputString;</span>
            }

            // Encrypt file
<span class="nc" id="L107">            File file = new File(this.path);</span>

<span class="nc" id="L109">            FileOutputStream fileOutputStream = new FileOutputStream(this.path);</span>
<span class="nc" id="L110">            fileOutputStream.write(fileContent, 0, fileContent.length);</span>

<span class="nc" id="L112">            byte[] cipherText = fe.encryptFile(file);</span>
<span class="nc" id="L113">            byte[] iv = fe.getIV();</span>

<span class="nc" id="L115">            FileOutputStream outputStream = new FileOutputStream(file);</span>
<span class="nc" id="L116">            fileOutputStream.close();</span>
<span class="nc" id="L117">            outputStream.write(iv);</span>
<span class="nc" id="L118">            outputStream.write(cipherText);</span>
<span class="nc" id="L119">            outputStream.close();</span>

            // TODO: Store user permissions info
            // String encodedKey = Base64.getEncoder().encodeToString(sk.getEncoded());
<span class="nc" id="L123">        } else {</span>
<span class="nc" id="L124">            FileOutputStream fileOutputStream = new FileOutputStream(this.path);</span>
<span class="nc" id="L125">            fileOutputStream.write(fileContent, 0, fileContent.length);</span>
<span class="nc" id="L126">            fileOutputStream.close();</span>
        }
<span class="nc" id="L128">        return outputString;</span>
    }

    /***
     * Deletes file and send message to requester if the file does not exist.
     * 
     * return: (String) whether or not the file was deleted
     */
    public String deleteFile(String username) throws IOException, CsvValidationException, CsvException {
<span class="nc" id="L137">        String userOutput = &quot;File has not been deleted...either does not exist or something else went wrong.&quot;;</span>
<span class="nc" id="L138">        File file = new File(this.path);</span>
        // Check if the user has write privileges
<span class="nc" id="L140">        int row = this.searchUserPermissionsCSV(username);</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (row != -1) {</span>
<span class="nc" id="L142">            String[] userPermissionInfo = this.retrieveUserPermissionsCSV(username);</span>
<span class="nc bnc" id="L143" title="All 6 branches missed.">            if (userPermissionInfo != null &amp;&amp; userPermissionInfo.length == 3 &amp;&amp; userPermissionInfo[2].contains(&quot;w&quot;)) {</span>
<span class="nc" id="L144">                boolean deleted = file.delete();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                if (deleted) {</span>
<span class="nc" id="L146">                    ArrayList&lt;Integer&gt; rowList = this.searchFilenameCSV();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                    if (rowList.size() != 0) {</span>
                        // Delete lines
<span class="nc" id="L149">                        System.out.println(rowList);</span>
<span class="nc" id="L150">                        this.deleteFileCSV(rowList);</span>
                    }
<span class="nc" id="L152">                    userOutput = this.path + &quot; was deleted&quot;;</span>
                }
<span class="nc" id="L154">            } else {</span>
<span class="nc" id="L155">                userOutput = &quot;You do not have the proper permissions to delete this file.&quot;;</span>
            }
        }
<span class="nc" id="L158">        return userOutput;</span>
    }

    /***
     * Outputs current working directory
     * 
     * return: (String) output to print to user
     */
    public String pwd() {
<span class="nc" id="L167">        String output = &quot;Working Directory: &quot; + System.getProperty(&quot;user.dir&quot;) + &quot;/&quot; + this.path;</span>
<span class="nc" id="L168">        return output;</span>
    }

    /***
     * Lists files in server directory
     * 
     * return: (String) output to print to user
     */
    public String listFiles() {
<span class="nc" id="L177">        File directory = new File(this.path);</span>

<span class="nc" id="L179">        File[] files = directory.listFiles();</span>

        String output;
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (directory.isDirectory()) {</span>
            // Check if there are files in the directory
<span class="nc bnc" id="L184" title="All 2 branches missed.">            if (files != null) {</span>
<span class="nc" id="L185">                output = &quot;Files in the directory: &quot;;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                for (File file : files) {</span>
<span class="nc" id="L187">                    output += file.getName() + &quot; &quot;;</span>
                }
            } else {
<span class="nc" id="L190">                output = &quot;No files in the directory.&quot;;</span>
            }
        } else {
<span class="nc" id="L193">            output = &quot;The path you provided is not a directory&quot;;</span>
        }
<span class="nc" id="L195">        return output;</span>
    }

    /***
     * Outputs current working directory
     * 
     * return: (String) output to print to user
     */
    public String shareFile(String username, String sharedUsername, String privileges) throws CsvException, IOException {
<span class="nc" id="L204">        String output = &quot;File not shared for some reason...&quot;;</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (appendUserPermissionsCSV(username, sharedUsername, privileges)) {</span>
<span class="nc" id="L206">            output = &quot;File Shared&quot;;</span>
        } else {
<span class="nc" id="L208">            output = &quot;Issue with File Share, do you write permissions on this file? If not, you cannot share the file.&quot;;</span>
        }
<span class="nc" id="L210">        return output;</span>
    }


    public boolean appendUserPermissionsCSV(String username, String sharedUsername, String privileges) throws IOException, CsvException, CsvValidationException {
<span class="nc" id="L215">        CSVWriter writer = new CSVWriter(new FileWriter(this.csv, true));</span>

        // See if already in file 
<span class="nc" id="L218">        int row = this.searchUserPermissionsCSV(username);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (row != -1) {</span>
<span class="nc" id="L220">            String[] userPermissionInfo = this.retrieveUserPermissionsCSV(username);</span>
<span class="nc bnc" id="L221" title="All 6 branches missed.">            if (userPermissionInfo != null &amp;&amp; userPermissionInfo.length == 3 &amp;&amp; userPermissionInfo[2].contains(&quot;w&quot;)) {</span>
                // then we are looking to append new permissions for username
<span class="nc bnc" id="L223" title="All 2 branches missed.">                if (sharedUsername == null) {</span>
                    // Delete line bc needing to override file on server potentially
<span class="nc" id="L225">                    this.deleteUserPermissions(row);</span>
                } 
                // then we are looking to append new permissions for sharedUsername
                else {
                    // check if the sharedUsername is already in the share file
<span class="nc" id="L230">                    int sharedRow = this.searchUserPermissionsCSV(sharedUsername);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">                    if (sharedRow != -1) {</span>
<span class="nc" id="L232">                        String[] sharedUserPermissionInfo = this.retrieveUserPermissionsCSV(username);</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">                        if (sharedUserPermissionInfo != null &amp;&amp; sharedUserPermissionInfo.length == 3) {</span>
<span class="nc" id="L234">                            String currentPermissions = sharedUserPermissionInfo[2];</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                            if (privileges.equals(currentPermissions)) {</span>
<span class="nc" id="L236">                                writer.close();</span>
<span class="nc" id="L237">                                return true;</span>
                            } else {
<span class="nc" id="L239">                                this.deleteUserPermissions(sharedRow);</span>
<span class="nc" id="L240">                                privileges = &quot;rw&quot;;</span>
                            }
                        }
                    }
<span class="nc" id="L244">                    String [] shareKeyInfo = {this.path, sharedUsername, privileges};</span>
<span class="nc" id="L245">                    writer.writeNext(shareKeyInfo);</span>
<span class="nc" id="L246">                    writer.close();</span>
<span class="nc" id="L247">                    return true;</span>
                }
            }
            // case where user only has read privileges, so shouldn't be able to edit the permissions of the file
            else {
<span class="nc" id="L252">                writer.close();</span>
<span class="nc" id="L253">                return false;</span>
            }
<span class="nc" id="L255">        }</span>
        else {
<span class="nc" id="L257">            ArrayList&lt;Integer&gt; rowList = this.searchFilenameCSV();</span>
            // This is the case where you don't have permission to write to this file name and someone else does
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (rowList.size() != 0) {</span>
                // userOutput = &quot;You do not have permission to override the current file with that name on the server. Please change the name of your file.&quot;;
                // System.out.println(userOutput);
<span class="nc" id="L262">                writer.close();</span>
<span class="nc" id="L263">                return false;</span>
            }
        }
    
<span class="nc" id="L267">        String [] fileKeyInfo = {this.path, username, privileges};</span>
<span class="nc" id="L268">        writer.writeNext(fileKeyInfo);</span>
<span class="nc" id="L269">        writer.close();</span>
<span class="nc" id="L270">        return true;</span>
    }

    public String[] retrieveUserPermissionsCSV(String username) throws IOException, CsvValidationException {
        try {
<span class="nc" id="L275">            FileReader filereader = new FileReader(this.csv); </span>
        
<span class="nc" id="L277">            CSVReader csvReader = new CSVReader(filereader); </span>
<span class="nc" id="L278">            String[] nextRecord = {}; </span>
  
            // we are going to read data line by line 
<span class="nc bnc" id="L281" title="All 2 branches missed.">            while ((nextRecord = csvReader.readNext()) != null) { </span>
<span class="nc bnc" id="L282" title="All 6 branches missed.">                if (nextRecord.length &gt; 0 &amp;&amp; nextRecord[0].equals(this.path) &amp;&amp; nextRecord[1].equals(username)) {</span>
<span class="nc" id="L283">                    csvReader.close();</span>
<span class="nc" id="L284">                    return nextRecord;</span>
                }
            }
        }
<span class="nc" id="L288">        catch (IOException io) {</span>
<span class="nc" id="L289">            System.out.println(io);</span>
<span class="nc" id="L290">        }</span>
        // System.out.println(&quot;File Access Denied&quot;);
<span class="nc" id="L292">        return null;</span>
    }

    public int searchUserPermissionsCSV(String username) throws IOException, CsvValidationException {
        try {
<span class="nc" id="L297">            CSVReader csvReader = new CSVReader(new FileReader(this.csv)); </span>
<span class="nc" id="L298">            String[] nextRecord = {}; </span>
<span class="nc" id="L299">            int row = 0;</span>
            // we are going to read data line by line 
<span class="nc bnc" id="L301" title="All 2 branches missed.">            while ((nextRecord = csvReader.readNext()) != null) { </span>
<span class="nc bnc" id="L302" title="All 6 branches missed.">                if (nextRecord.length &gt; 0 &amp;&amp; nextRecord[0].equals(this.path) &amp;&amp; nextRecord[1].equals(username)) {</span>
<span class="nc" id="L303">                    csvReader.close();</span>
<span class="nc" id="L304">                    return row;</span>
                }
<span class="nc" id="L306">                row++;</span>
            }
<span class="nc" id="L308">            csvReader.close();</span>
        }
<span class="nc" id="L310">        catch (IOException io) {</span>
<span class="nc" id="L311">            System.out.println(io);</span>
<span class="nc" id="L312">        }</span>
<span class="nc" id="L313">        return -1;</span>
    }

    public int searchUserPermissionsCSV() throws IOException, CsvValidationException {
        try {
<span class="nc" id="L318">            CSVReader csvReader = new CSVReader(new FileReader(this.csv)); </span>
<span class="nc" id="L319">            String[] nextRecord = {}; </span>
<span class="nc" id="L320">            int row = 0;</span>
            // we are going to read data line by line 
<span class="nc bnc" id="L322" title="All 2 branches missed.">            while ((nextRecord = csvReader.readNext()) != null) { </span>
<span class="nc bnc" id="L323" title="All 4 branches missed.">                if (nextRecord.length &gt; 0 &amp;&amp; nextRecord[0].equals(this.path)) {</span>
<span class="nc" id="L324">                    csvReader.close();</span>
<span class="nc" id="L325">                    return row;</span>
                }
<span class="nc" id="L327">                row++;</span>
            }
<span class="nc" id="L329">            csvReader.close();</span>
        }
<span class="nc" id="L331">        catch (IOException io) {</span>
<span class="nc" id="L332">            System.out.println(io);</span>
<span class="nc" id="L333">        }</span>
<span class="nc" id="L334">        return -1;</span>
    }

    public ArrayList&lt;Integer&gt; searchFilenameCSV() throws IOException, CsvValidationException {
<span class="nc" id="L338">        ArrayList&lt;Integer&gt; rowList = new ArrayList&lt;Integer&gt;();</span>
        try {
<span class="nc" id="L340">            CSVReader csvReader = new CSVReader(new FileReader(this.csv)); </span>
<span class="nc" id="L341">            String[] nextRecord = {}; </span>
<span class="nc" id="L342">            int row = 0;</span>
            // we are going to read data line by line 
<span class="nc bnc" id="L344" title="All 2 branches missed.">            while ((nextRecord = csvReader.readNext()) != null) { </span>
<span class="nc bnc" id="L345" title="All 4 branches missed.">                if (nextRecord.length &gt; 0 &amp;&amp; nextRecord[0].equals(this.path)) {</span>
<span class="nc" id="L346">                    rowList.add(row);</span>
                }
<span class="nc" id="L348">                row++;</span>
            }
<span class="nc" id="L350">            csvReader.close();</span>
        }
<span class="nc" id="L352">        catch (IOException io) {</span>
<span class="nc" id="L353">            System.out.println(io);</span>
<span class="nc" id="L354">        }</span>
<span class="nc" id="L355">        return rowList;</span>
    }

    public void deleteUserPermissions(int rowNumber) throws IOException, CsvException, CsvValidationException {
<span class="nc" id="L359">        CSVReader reader = new CSVReader(new FileReader(this.csv));</span>
<span class="nc" id="L360">        List&lt;String[]&gt; allElements = reader.readAll();</span>
<span class="nc" id="L361">        allElements.remove(rowNumber);</span>
<span class="nc" id="L362">        FileWriter sw = new FileWriter(this.csv);</span>
<span class="nc" id="L363">        CSVWriter writer = new CSVWriter(sw);</span>
<span class="nc" id="L364">        writer.writeAll(allElements);</span>
<span class="nc" id="L365">        reader.close();</span>
<span class="nc" id="L366">        writer.close();</span>
<span class="nc" id="L367">    }</span>

    public void deleteFileCSV(ArrayList&lt;Integer&gt; rowList) throws IOException, CsvException, CsvValidationException {
<span class="nc" id="L370">        CSVReader reader = new CSVReader(new FileReader(this.csv));</span>
<span class="nc" id="L371">        List&lt;String[]&gt; allElements = reader.readAll();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">        for (int i = rowList.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L373">            int row = rowList.get(i);</span>
<span class="nc" id="L374">            allElements.remove(row);</span>
        }
<span class="nc" id="L376">        System.out.println(allElements);</span>
<span class="nc" id="L377">        CSVWriter writer = new CSVWriter(new FileWriter(this.csv));</span>
<span class="nc" id="L378">        writer.writeAll(allElements);</span>
<span class="nc" id="L379">        reader.close();</span>
<span class="nc" id="L380">        writer.close();</span>
<span class="nc" id="L381">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>